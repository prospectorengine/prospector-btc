# =================================================================
# APARATO: MATHEMATIC TEST SWITCH (V1.4 - PNPM SSoT ALIGNED)
# CLASIFICACI√ìN: OPS INFRASTRUCTURE (ESTRATO L6)
# RESPONSABILIDAD: CERTIFICACI√ìN MANUAL DEL N√öCLEO MATEM√ÅTICO L1
#
# VISION HIPER-HOL√çSTICA 2026:
# 1. VERSION SOVEREIGNTY: Elimina el conflicto ERR_PNPM_BAD_PM_VERSION
#    delegando la autoridad al campo 'packageManager' del package.json.
# 2. RUNTIME REFINERY: Sincroniza Node.js 20.x con el motor pnpm v10.
# 3. ATOMIC INSTALL: Implementa instalaci√≥n estricta con frozen-lockfile.
# 4. ZERO RESIDUE: Gesti√≥n de cach√© optimizada para binarios Rust y Node.
# =================================================================

name: "L1: Mathematic Test Switch"

on:
  workflow_dispatch:
    inputs:
      compilation_profile:
        description: 'Perfil de Auditor√≠a (Release recomendado para Criptograf√≠a)'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release
      verbose_output:
        description: 'Activar verbosidad forense (--nocapture)'
        required: true
        default: true
        type: boolean

jobs:
  certification:
    name: "L1_Math_Audit"
    runs-on: ubuntu-latest

    # Protecci√≥n de recursos ante bucles de tortura infinitos
    timeout-minutes: 30

    steps:
      - name: "üõ∞Ô∏è DNA_ACQUISITION: Checkout Strata"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è  ENV_STRATIFICATION: Rust Nightly Engine"
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: "üì¶ NODE_SINCRO: Install pnpm"
        uses: pnpm/action-setup@v4
        # ‚úÖ REPARACI√ìN: Se remueve la versi√≥n hardcoded para evitar conflicto con package.json

      - name: "üåê RUNTIME_SETUP: Node.js 20.x"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: "üß™ I18N_HYDRATION: Generating Dictionaries"
        run: |
          pnpm install --frozen-lockfile
          pnpm i18n:generate

      - name: "üíé CACHE_HANDSHAKE: Restoring Cargo & Nx Strata"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
            dist
          key: ${{ runner.os }}-l1-math-v1.4-${{ hashFiles('**/Cargo.toml', 'pnpm-lock.yaml') }}

      - name: "üí• EXECUTION: Firing 20 Proving Grounds Tests"
        env:
          ORCHESTRATOR_URL: ${{ secrets.ORCHESTRATOR_URL }}
          WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}
          RUST_BACKTRACE: 1
        run: |
          PROFILE_FLAG=""
          if [ "${{ github.event.inputs.compilation_profile }}" == "release" ]; then
            PROFILE_FLAG="--release"
          fi

          VERBOSE_FLAG=""
          if [ "${{ github.event.inputs.verbose_output }}" == "true" ]; then
            VERBOSE_FLAG="-- --nocapture"
          fi

          echo "üöÄ Starting L1 Core Math Certification..."
          cargo test --package prospector-core-math $PROFILE_FLAG $VERBOSE_FLAG

      - name: "üèÅ VERDICT: Final Strata Report"
        if: always()
        run: |
          echo "Mathematical Integrity sequence finalized."
