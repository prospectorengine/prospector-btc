# =================================================================
# APARATO: MATHEMATIC TEST SWITCH (V1.3 - TYPE CORRECTED)
# CLASIFICACI√ìN: OPS INFRASTRUCTURE (ESTRATO L6)
# RESPONSABILIDAD: CERTIFICACI√ìN MANUAL DEL N√öCLEO MATEM√ÅTICO L1
#
# VISION HIPER-HOL√çSTICA 2026:
# 1. TYPE INTEGRITY: Resuelve el error 'StringToken vs BooleanToken'
#    nivelando el valor por defecto al est√°ndar YAML booleano.
# 2. RUNTIME REFINERY: Utiliza pnpm v4 para una sinapsis m√°s r√°pida
#    con el monorepo Nx.
# 3. ZERO ABBREVIATIONS: Nomenclatura nominal absoluta en inputs.
# 4. HYGIENE: Cero redundancia en la adquisici√≥n de dependencias.
# =================================================================

name: "L1: Mathematic Test Switch"

on:
  workflow_dispatch:
    inputs:
      compilation_profile:
        description: 'Perfil de Auditor√≠a (Release recomendado para Criptograf√≠a)'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release
      verbose_output:
        description: 'Activar verbosidad forense (--nocapture)'
        required: true
        # ‚úÖ REPARACI√ìN: Se remueven comillas para satisfacer el tipo 'boolean'
        default: true
        type: boolean

jobs:
  certification:
    name: "L1_Math_Audit"
    runs-on: ubuntu-latest

    # Protecci√≥n de recursos ante bucles de tortura infinitos
    timeout-minutes: 30

    steps:
      - name: "üõ∞Ô∏è DNA_ACQUISITION: Checkout Strata"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è  ENV_STRATIFICATION: Rust Nightly Engine"
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: "üì¶ NODE_SINCRO: Provisioning pnpm v10"
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: "üß™ I18N_HYDRATION: Generating Dictionaries"
        run: |
          pnpm install --frozen-lockfile
          pnpm i18n:generate

      - name: "üíé CACHE_HANDSHAKE: Restoring Cargo & Nx Strata"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
            dist
          key: ${{ runner.os }}-l1-math-gold-v1.3-${{ hashFiles('**/Cargo.toml', 'pnpm-lock.yaml') }}

      - name: "üí• EXECUTION: Firing 20 Proving Grounds Tests"
        env:
          ORCHESTRATOR_URL: ${{ secrets.ORCHESTRATOR_URL }}
          WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}
          RUST_BACKTRACE: 1
        run: |
          # 1. Triaje de Perfil
          PROFILE_FLAG=""
          if [ "${{ github.event.inputs.compilation_profile }}" == "release" ]; then
            PROFILE_FLAG="--release"
          fi

          # 2. Triaje de Verbosidad
          VERBOSE_FLAG=""
          if [ "${{ github.event.inputs.verbose_output }}" == "true" ]; then
            VERBOSE_FLAG="-- --nocapture"
          fi

          echo "üöÄ Starting L1 Core Math Certification..."
          echo "   Profile: ${{ github.event.inputs.compilation_profile }}"
          echo "   Verbosidad: ${{ github.event.inputs.verbose_output }}"

          cargo test --package prospector-core-math $PROFILE_FLAG $VERBOSE_FLAG

      - name: "üèÅ VERDICT: Final Strata Report"
        if: always()
        run: |
          echo "Mathematical Integrity sequence finalized."
