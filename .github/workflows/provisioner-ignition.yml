# =================================================================
# APARATO: HYDRA SWARM IGNITION (V4.0 - ANTI-FLOOD SOBERANO)
# CLASIFICACI√ìN: C2 ACTUATOR (ESTRATO L6)
# RESPONSABILIDAD: DESPLIEGUE T√ÅCTICO DE NODOS CON AUTOCONTENCI√ìN
# =================================================================

name: "Hydra-Zero: Swarm Ignition"

on:
  workflow_dispatch:
    inputs:
      worker_count_per_shard:
        description: 'Densidad de Nodos por Shard (Recomendado: 5-30)'
        required: true
        default: '5'
      shard_count:
        description: 'N√∫mero de Shards (M√°ximo: 10 en Free Tier)'
        required: true
        default: '1'

  repository_dispatch:
    types: [swarm_ignition, swarm_resurrection]

# üõ°Ô∏è ESCUDO DE CONCURRENCIA SOBERANO (ANTI-AVALANCHE)
# Si llega una nueva orden de mando, se cancelan todas las anteriores
# que est√©n 'queued' o 'in_progress' para esta rama.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write # Necesario para auto-mantenimiento si se requiere

jobs:
  # job 1: Generador de Matriz (Resuelve la regresi√≥n de sintaxis)
  prepare-matrix:
    name: üß† Pre-Flight Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # Genera una secuencia real [1, 2, ..., N]
          COUNT=${{ github.event.inputs.shard_count || github.event.client_payload.shard_count || 1 }}
          JSON_ARRAY=$(seq 1 $COUNT | jq -R . | jq -s -c .)
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT

  ignite-swarm:
    name: üöÄ Deploy Shard
    needs: prepare-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 360 # L√≠mite de vida del nodo (6h)
    strategy:
      fail-fast: false
      matrix:
        shard_index: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - name: üì• Initialize Vector
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js 20.19.0
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'pnpm'

      - name: üì¶ Install Tactical Deps
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile --filter @prospector/provisioner...

      - name: üé≠ Provision Playwright (Chromium Only)
        run: pnpm exec playwright install chromium --with-deps

      - name: üî• IGNITE SHARD ${{ matrix.shard_index }}
        env:
          # --- NEURAL UPLINK ---
          ORCHESTRATOR_URL: ${{ secrets.ORCHESTRATOR_URL }}
          WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}

          # --- IDENTITY VAULT (PHOENIX READY) ---
          GOOGLE_COOKIES_JSON: ${{ secrets.GOOGLE_COOKIES_JSON }}
          MASTER_VAULT_KEY: ${{ secrets.MASTER_VAULT_KEY }}

          # --- ARTIFACTS & CENSUS ---
          MINER_BINARY_URL: ${{ secrets.MINER_BINARY_URL }}
          FILTER_BASE_URL: ${{ secrets.FILTER_BASE_URL }}
          FILTER_SHARDS: ${{ secrets.FILTER_SHARDS }}

          # --- MISSION PARAMS ---
          # Se inyecta el Shard Index para que el Provisioner genere IDs un√≠vocos
          WORKER_ID_PREFIX: "hydra-shard-${{ matrix.shard_index }}"
          WORKER_COUNT: ${{ github.event.inputs.worker_count_per_shard || github.event.client_payload.worker_count || 5 }}
          HEADLESS: "true"
        run: |
          echo "üí† IGNITION SEQUENCE STARTING: SHARD ${{ matrix.shard_index }}"
          echo "   Target Capacity: $WORKER_COUNT hilos"
          pnpm --filter @prospector/provisioner run start
