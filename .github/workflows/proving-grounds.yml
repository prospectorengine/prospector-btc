# =================================================================
# APARATO: INTEGRITY PROVING GROUNDS (V2.0 - ANTI-FLOOD)
# CLASIFICACI√ìN: OPS STRATUM (L6)
# RESPONSABILIDAD: CERTIFICACI√ìN BAJO DEMANDA (MANUAL/PR)
# =================================================================

name: "Hydra-Zero: Integrity Proving Grounds"

# ‚úÖ ESTRATEGIA DE DISPARO SOBERANA
on:
  workflow_dispatch: # Bot√≥n Manual
    inputs:
      profile:
        description: 'Compilaci√≥n Profile'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug
      target_scope:
        description: 'Alcance de la Auditor√≠a'
        required: true
        default: 'workspace'
        type: choice
        options:
        - workspace
        - core-math
        - strategy
        - orchestrator

  # ‚úÖ GATEKEEPER: Solo se activa en PRs, no en cada commit a main
  pull_request:
    branches: [ "main" ]
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'Cargo.toml'

# ‚úÖ ESCUDO DE CONCURRENCIA (KILL-SWITCH AUTOM√ÅTICO)
# Si lanzas este test 2 veces seguidas, el primero se cancela para ahorrar recursos.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
  # Optimizaci√≥n de cach√© de compilaci√≥n
  RUSTC_WRAPPER: ""

jobs:
  audit-matrix:
    name: üõ°Ô∏è Stratum Certification
    runs-on: ubuntu-latest
    timeout-minutes: 25 # L√≠mite duro para evitar zombies

    steps:
      - name: üì• Checkout Source Code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: ‚ö° Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2

      - name: üì¶ Install System Libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      # --- FASE 1: N√öCLEO MATEM√ÅTICO (L1) ---
      - name: üßÆ [L1] Core Math Integrity
        if: ${{ inputs.target_scope == 'workspace' || inputs.target_scope == 'core-math' || github.event_name == 'pull_request' }}
        run: |
          cargo test --profile ${{ inputs.profile || 'debug' }} --package prospector-core-math
          cargo test --profile ${{ inputs.profile || 'debug' }} --package prospector-core-probabilistic

      # --- FASE 2: ESTRATEGIA Y ARQUEOLOG√çA (L2) ---
      - name: üß† [L2] Strategic Engines
        if: ${{ inputs.target_scope == 'workspace' || inputs.target_scope == 'strategy' || github.event_name == 'pull_request' }}
        run: |
          cargo test --profile ${{ inputs.profile || 'debug' }} --package prospector-domain-forensics
          cargo test --profile ${{ inputs.profile || 'debug' }} --package prospector-domain-strategy

      # --- FASE 3: INFRAESTRUCTURA (L3/L4) ---
      - name: üõ∞Ô∏è [L3] Orchestrator & Phoenix
        if: ${{ inputs.target_scope == 'workspace' || inputs.target_scope == 'orchestrator' || github.event_name == 'pull_request' }}
        run: |
          # Validaci√≥n del Protocolo de Auto-Regeneraci√≥n
          cargo test --profile ${{ inputs.profile || 'debug' }} --package prospector-orchestrator --test identity_refresh_test
          cargo test --profile ${{ inputs.profile || 'debug' }} --package prospector-orchestrator --test governance_api_test

      - name: üèÅ Certification Seal
        if: success()
        run: echo "‚úÖ SYSTEM INTEGRITY VERIFIED."
