# =================================================================
# APARATO: PHANTOM SWARM GRID (V2.0 - OBSERVABLE)
# CLASIFICACI√ìN: OPS INFRASTRUCTURE (ESTRATO L6)
# RESPONSABILIDAD: EJECUCI√ìN PARALELA DE AUDITOR√çA FORENSE
#
# VISION HIPER-HOL√çSTICA:
# Utiliza la infraestructura de GitHub Actions como una supercomputadora
# distribuida. No requiere navegador ni cookies, ya que ejecuta el
# binario Rust nativo compilado est√°ticamente (MUSL).
# =================================================================

name: "Satoshi-XP Forensic Grid"

on:
  # Disparo manual para operaciones t√°cticas
  workflow_dispatch:
    inputs:
      grid_size:
        description: 'Capacidad del Enjambre (Solo informativo, matriz fija)'
        required: true
        default: '20 Units'

  # Ejecuci√≥n autom√°tica cronometrada para auditor√≠a continua
  # Cada 4 horas para maximizar el uso del Free Tier sin saturaci√≥n
  schedule:
    - cron: '0 */4 * * *'

jobs:
  forensic-node:
    name: "Unit-XP"
    runs-on: ubuntu-latest

    strategy:
      # Fail-Fast desactivado: Si un nodo falla, los otros 19 siguen trabajando.
      fail-fast: false
      matrix:
        # Despliegue de 20 unidades paralelas.
        # Esto genera 20 m√°quinas virtuales independientes simult√°neamente.
        node_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]

    steps:
      - name: üõ°Ô∏è Checkout Core Repository
        uses: actions/checkout@v4

      - name: üì• Hydrate Static Binary (Miner Worker)
        run: |
          echo "Initiating download of sovereign binary artifact..."
          # Descarga el binario MUSL desde la URL inyectada en Secretos
          curl -L -o miner-worker ${{ secrets.MINER_BINARY_URL }}

          # Otorga permisos de ejecuci√≥n al kernel
          chmod +x miner-worker

          # Verificaci√≥n de integridad f√≠sica
          ls -lh miner-worker
          echo "Binary hydration complete. Permissions verified."

      - name: üöÄ Ignite Forensic Kernel
        env:
          # --- ENLACE T√ÅCTICO C2 ---
          ORCHESTRATOR_URL: ${{ secrets.ORCHESTRATOR_URL }}
          WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}

          # --- IDENTIDAD DEL NODO ---
          # Genera un ID √∫nico para trazabilidad en el Dashboard L5
          WORKER_NODE_IDENTIFIER: "gh-actions-forensic-unit-${{ matrix.node_id }}"

          # --- AFINIDAD DE HARDWARE ---
          # Los runners de GitHub tienen 2 vCPUs. Limitamos los hilos para evitar
          # sobrecarga del planificador del SO y maximizar el Hashrate neto.
          RAYON_NUM_THREADS: 2

          # --- OBSERVABILIDAD AUMENTADA ---
          # 'info' para el sistema general, 'debug' para ver la miner√≠a en tiempo real.
          # Esto soluciona el problema del "Silencio de Radio".
          RUST_LOG: "info,prospector_miner=debug"

        run: |
          echo "=========================================="
          echo "üî• IGNITION SEQUENCE STARTED"
          echo "UNIT ID: $WORKER_NODE_IDENTIFIER"
          echo "TARGET: $ORCHESTRATOR_URL"
          echo "LOG LEVEL: $RUST_LOG"
          echo "=========================================="

          # Ejecuci√≥n del binario. El proceso se mantendr√° vivo solicitando misiones
          # hasta que se agote el tiempo del runner (6 horas) o se cancele.
          ./miner-worker
