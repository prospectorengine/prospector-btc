# =================================================================
# APARATO: SYSTEM HEALTH PROPRIOCEPTION (V12.1 - SOBERANO)
# CLASIFICACI√ìN: OPS AUTOMATION (ESTRATO L6)
# RESPONSABILIDAD: MONITOREO CERRADO DE INTEGRIDAD MULTI-MOTOR
# =================================================================

name: "Sovereign System Proprioception"

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  diagnostic_audit:
    name: "Execute Infrastructure Scanners"
    runs-on: ubuntu-latest

    env:
      # SINAPSIS CON EL MOTOR B (SUPABASE)
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      # SINAPSIS CON EL MOTOR A (TURSO)
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}

      # SEGURIDAD T√ÅCTICA
      WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      # CONFIGURACI√ìN CR√çTICA DE COMPILADOR (RESOLUCI√ìN DE REGRESI√ìN 1)
      TS_NODE_COMPILER_OPTIONS: '{"module":"commonjs","esModuleInterop":true}'

    steps:
      - name: "üõ∞Ô∏è [VCS]: Clone Sovereign Repository"
        uses: actions/checkout@v4

      - name: "üü¢ [RUNTIME]: Initialize Node.js (V20.19.0)"
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: "üì¶ [DEPS]: Install PNPM (V10.26.1)"
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.1

      - name: "üèóÔ∏è [HYDRATION]: Sync Dependencies & I18n"
        run: |
          pnpm install --frozen-lockfile
          pnpm i18n:generate

      - name: "üïµÔ∏è [SENSOR_01]: Strategic Topology Inspector"
        # Usamos npx con las ENVs de compilaci√≥n ya cargadas globalmente
        run: npx ts-node tools/scripts/supabase/topology_inspector.ts
        continue-on-error: true

      - name: "üõ∞Ô∏è [SENSOR_02]: Strategic Link Auditor"
        # Priorizamos el uso de scripts definidos en package.json (SSoT)
        run: pnpm db:supabase:audit
        continue-on-error: true

      - name: "‚öñÔ∏è [SENSOR_03]: Twin-Engine Parity Auditor"
        run: pnpm db:sync:check
        continue-on-error: true

      - name: "üíé [CRYSTALLIZE]: Final Heartbeat"
        if: always()
        run: |
          echo "[#] [$(date)] Proprioception cycle completed for Kernel V11.5"
