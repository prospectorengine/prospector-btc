name: Hydra Binary Forge

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Etiqueta del Release (ej: v110.13-hydra)'
        required: true
        default: 'v110.13-hydra'

env:
  BINARY_NAME: miner-worker
  TARGET_TRIPLE: x86_64-unknown-linux-musl

jobs:
  forge-and-release:
    name: ðŸ”¨ Forge & Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write # CRÃTICO: Permite crear Releases

    steps:
      - name: ðŸ“¥ Checkout Source
        uses: actions/checkout@v4

      - name: ðŸ¦€ Install Rust Nightly (Elite SIMD Support)
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ env.TARGET_TRIPLE }}

      - name: ðŸ—ï¸ Install Musl Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: âš¡ Compile Static Binary
        run: |
          # CompilaciÃ³n estÃ¡tica para mÃ¡xima portabilidad (Colab/Alpine/Ubuntu)
          cargo build --release --bin ${{ env.BINARY_NAME }} --target ${{ env.TARGET_TRIPLE }}

      - name: ðŸª¶ Optimize Binary (Strip)
        run: |
          # ReducciÃ³n de tamaÃ±o: Elimina sÃ­mbolos de depuraciÃ³n (50MB -> 5MB)
          strip target/${{ env.TARGET_TRIPLE }}/release/${{ env.BINARY_NAME }}

          # VerificaciÃ³n de integridad
          file target/${{ env.TARGET_TRIPLE }}/release/${{ env.BINARY_NAME }}
          ls -lh target/${{ env.TARGET_TRIPLE }}/release/${{ env.BINARY_NAME }}

      - name: ðŸ“¦ Prepare Artifacts
        run: |
          mkdir -p dist
          cp target/${{ env.TARGET_TRIPLE }}/release/${{ env.BINARY_NAME }} dist/

          # Generar Checksum para validaciÃ³n forense
          cd dist
          sha256sum ${{ env.BINARY_NAME }} > ${{ env.BINARY_NAME }}.sha256

      - name: ðŸš€ Publish to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: "Hydra Release ${{ github.event.inputs.tag_name }}"
          draft: false
          prerelease: false
          files: |
            dist/${{ env.BINARY_NAME }}
            dist/${{ env.BINARY_NAME }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

