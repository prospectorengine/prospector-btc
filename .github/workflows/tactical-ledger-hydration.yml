# =================================================================
# APARATO: TACTICAL LEDGER HYDRATION (V1.0 - SOBERANO)
# CLASIFICACI√ìN: OPS INFRASTRUCTURE (ESTRATO L6)
# RESPONSABILIDAD: Hidrataci√≥n Remota del Motor A (Turso)
# =================================================================

name: "üí† Hydra Genesis: Tactical Ledger Hydration"

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Justificaci√≥n del Mando para la re-hidrataci√≥n'
        required: true
        default: 'MANUAL_GENESIS_IGNITION'

jobs:
  ignition:
    name: "Crystallizing Genesis Strata"
    runs-on: ubuntu-latest

    # Estratos de Seguridad: No permitimos ejecuciones concurrentes para evitar colisiones ACID
    concurrency:
      group: ledger-hydration
      cancel-in-progress: false

    steps:
      - name: "üõ∞Ô∏è [1/5] Adquiring Source Code"
        uses: actions/checkout@v4

      - name: "ü¶Ä [2/5] Initializing Rust Toolchain (Nightly)"
        uses: dtolnay/rust-toolchain@nightly

      - name: "üì¶ [3/5] Synchronizing Binary Cache"
        uses: Swatinem/rust-cache@v2

      - name: "üß¨ [4/5] Executing Atomic Seed Sequence"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          RUST_LOG: info
        run: |
          echo "Initiating release build for Genesis Forge..."
          cargo run --release --bin seed

      - name: "üõ°Ô∏è [5/5] Final Integrity Audit"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          echo "Verifying system_state table crystallization..."
          # Comprobaci√≥n r√°pida v√≠a SQL crudo para certificar el √©xito del binario
          curl -s -X POST "${{ secrets.DATABASE_URL }}/v1/execute" \
            -H "Authorization: Bearer ${{ secrets.TURSO_AUTH_TOKEN }}" \
            -d '{"statements": ["SELECT * FROM system_state WHERE key = '"'active_census_audit_token'"';"]}'
